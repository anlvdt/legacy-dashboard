<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Legacy Frame by An Le - Make old device great again!</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&family=Lato:wght@900&display=swap" rel="stylesheet">
    <style>
        :root {
            --text-primary: #F5F5F5;
            --text-secondary: #f39c12;
            --text-weather: #2980b9;
            --ui-blur: 20px;
            --ui-radius: 2vmin;
            --ui-bg: rgba(28, 28, 28, 0.45);
            --ui-border: 1px solid rgba(255, 255, 255, 0.1);
        }

        html { font-size: 1.5vmin; }
        @media (max-width: 480px) { html { font-size: 10px; } }
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
        
        body {
            background-color: #000;
            color: var(--text-primary);
            font-family: 'Nunito', sans-serif;
            transition: all 0.5s ease;
        }

        #background-container {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: -1;
            transition: opacity 0.5s ease;
        }
        
        body.power-save-mode #background-container {
            opacity: 0;
        }

        #background-image {
            width: 100%; height: 100%;
            object-fit: cover;
            transition: opacity 1.5s ease-in-out;
            opacity: 0;
        }
        #background-image.loaded {
            opacity: 1;
        }

        .container { 
            display: flex; 
            width: 100%; 
            height: 100%; 
            position: relative;
            padding: 2.5vmin;
            box-sizing: border-box;
        }
        
        .info-column, .qr-column {
            flex: 1 1 0;
            display: flex;
            height: 100%;
            overflow: hidden;
            transition: all 0.5s ease;
        }
        .info-column { flex-grow: 1.2; margin-right: 2.5vmin; }
        .qr-column { flex-grow: 0.8; }

        .content-wrapper { display: flex; flex-direction: column; width: 100%; height: 100%; text-align: center; overflow: hidden; }
        
        .flex-grow-item { display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 0; transition: all 0.4s ease; }
        #digital-clock-wrapper { flex-grow: 1.2; }
        #date-weather-group { flex-grow: 1; flex-direction: column; justify-content: center; }
        #calendar-wrapper { flex-grow: 1.5; }

        .clock-segment {
            background: var(--ui-bg);
            border: var(--ui-border);
            border-radius: var(--ui-radius);
            padding: 0.5vmin 2vmin;
            position: relative;
            box-shadow: 0 0.5vmin 2vmin rgba(0,0,0,0.5);
            margin: 0 0.5vmin;
            backdrop-filter: blur(var(--ui-blur));
            -webkit-backdrop-filter: blur(var(--ui-blur));
        }
        
        #digital-clock { display: flex; justify-content: center; align-items: center; width: 100%; line-height: 1; }
        .clock-segment span, .clock-separator { font-family: 'Lato', sans-serif; font-weight: 900; color: var(--text-primary); text-shadow: 0 0 1vmin rgba(255,255,255,0.2); transition: font-size 0.3s ease; }
        .clock-segment span { font-size: 13vmin; letter-spacing: 0.05em; }
        .clock-separator { font-size: 10vmin; }
        
        .clock-seconds { display: flex; align-items: center; max-width: 0; opacity: 0; overflow: hidden; transition: max-width 0.5s ease, opacity 0.5s ease; }
        #digital-clock.seconds-visible .clock-segment span { font-size: 8vmin; }
        #digital-clock.seconds-visible .clock-separator { font-size: 7vmin; }
        #digital-clock.seconds-visible .clock-seconds { max-width: 30vmin; opacity: 1; }
        
        @-webkit-keyframes blink { 50% { opacity: 0.3; } }
        @keyframes blink { 50% { opacity: 0.3; } }
        
        .colon-blinking {
            -webkit-animation: blink 1s step-end infinite;
            animation: blink 1s step-end infinite;
        }

        .date-container { 
            font-size: 3.2vmin; 
            margin-bottom: 2vmin; 
            font-weight: 700;
            padding: 1vmin 2vmin;
            background: rgba(0,0,0,0.3);
            border-radius: 1.5vmin;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }
        .date-container p { margin: 1vmin 0; }
        #gregorian-date-p { opacity: 0.8; }
        #lunar-date-p { color: var(--text-secondary); }
        #lunar-event { color: #e67e22; min-height: 1em; }
        
        #weather-container { 
            display: block;
            font-weight: 700; 
            padding: 1.5vmin 2vmin;
            background: rgba(0,0,0,0.3);
            border-radius: 1.5vmin;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
            font-size: 4vmin;
        }
        #weather-container-line2 { display: flex; justify-content: center; align-items: center; }
        #weather-container-line2 > span { margin: 0 0.8rem; }
        #weather-icon { font-size: 5vmin; }
        #weather-location { color: var(--text-weather); margin-bottom: 1vmin; }

        #calendar-container {
            background: var(--ui-bg);
            border: var(--ui-border);
            padding: 1.5vmin;
            border-radius: var(--ui-radius);
            width: 100%;
            max-width: 48vmin;
            box-sizing: border-box;
            margin: 0 auto;
            backdrop-filter: blur(var(--ui-blur));
            -webkit-backdrop-filter: blur(var(--ui-blur));
        }
        #calendar-header { display: table; width: 100%; }
        .calendar-nav, #calendar-title { display: table-cell; vertical-align: middle; }
        #calendar-title { width: 70%; font-size: 2vmin; font-weight: 700; }
        .calendar-nav { width: 15%; cursor: pointer; font-size: 2.5vmin; user-select: none; }
        #calendar-grid { margin-top: 1vmin; }
        #calendar-grid::after { content: ""; display: table; clear: both; }
        .calendar-cell { float: left; width: 14.28%; box-sizing: border-box; position: relative; }
        .calendar-cell::before { content: ''; display: block; padding-top: 85%; }
        .calendar-cell-inner { position: absolute; top: 0.2rem; right: 0.2rem; bottom: 0.2rem; left: 0.2rem; display: flex; flex-direction: column; justify-content: center;}
        .cell-content { text-align: center; padding: 0.2rem 0; }
        .day-name .cell-content { font-weight: 700; color: var(--text-secondary); font-size: 1.6vmin; }
        .solar-day { font-size: 1.8vmin; font-weight: 700; display: block; }
        .lunar-day { font-size: 1.3vmin; display: block; color: var(--text-secondary); opacity: 0.8; }
        .other-month { opacity: 0.3; }
        .today .calendar-cell-inner { background-color: var(--text-secondary); color: #000; border-radius: 0.8vmin; font-weight: 700; }
        .today .lunar-day { color: #000; }
        
        .qr-column {
            background: var(--ui-bg);
            border: var(--ui-border);
            border-radius: var(--ui-radius);
            padding: 2.5vmin;
            box-sizing: border-box;
            backdrop-filter: blur(var(--ui-blur));
            -webkit-backdrop-filter: blur(var(--ui-blur));
        }
        .qr-wrapper { display: flex; flex-direction: column; justify-content: center; align-items: center; width: 100%; height: 100%; opacity: 0; transition: opacity 0.5s ease; }
        .qr-wrapper.loaded { opacity: 1; }
        .qr-code-image { width: 100%; max-width: 300px; height: auto; border-radius: 1vmin; border: 2px solid #fff; margin-bottom: 2vmin; }
        .shop-info { text-align: center; }
        .shop-name { font-family: 'Oswald', sans-serif; font-size: 3.5vmin; font-weight: 700; color: var(--text-secondary); margin: 0; }
        .shop-address { font-size: 2vmin; line-height: 1.4; margin: 1vmin 0 0 0; }
        
        .hidden-force { transition: opacity 0.4s ease, max-height 0.4s ease, margin 0.4s ease, padding 0.4s ease, flex-basis 0.4s ease; opacity: 0 !important; max-height: 0 !important; min-height: 0 !important; margin: 0 !important; padding: 0 !important; overflow: hidden !important; border: none !important; flex-grow: 0 !important; flex-basis: 0 !important; }

        .container.shop-hidden .qr-column, .container.slideshow-hidden .info-column, .container.slideshow-hidden .qr-column { flex-grow: 0; flex-basis: 0; margin: 0 !important; border: none !important; padding: 0 !important;}
        .container.slideshow-hidden .info-column { margin-right: 0; }
        .container.qr-hidden .qr-code-image { display: none; }
        
        #clock-only-overlay {
            display: none;
            flex-direction: column;
            justify-content: space-between; 
            align-items: center;
            width: 100%;
            height: 100%;
            padding: 3vh 2.5vmin;
            box-sizing: border-box;
            position: absolute;
            top: 0;
            left: 0;
        }

        #clock-only-date-container, #clock-only-weather-container { 
            width: auto;
            padding: 1.5vmin 3vmin;
            text-align: center; 
            font-size: 4vmin; 
            font-weight: 700;
            background: var(--ui-bg);
            border: var(--ui-border);
            border-radius: var(--ui-radius);
            backdrop-filter: blur(var(--ui-blur));
            -webkit-backdrop-filter: blur(var(--ui-blur));
             visibility: hidden;
        }
        #clock-only-weather-container-line2 { display: flex; align-items: center; justify-content: center; }
        #weather-location-overlay { margin-bottom: 1vmin; font-size: 0.8em; }
        #clock-only-date-container p { margin: 0.5vmin 0; }
        
        .container.clock-only-mode { display: none; }
        body.clock-only-mode #clock-only-overlay { display: flex; }
        body.clock-only-mode #settings-container { display: none; }

        body.clock-only-mode.show-dates #clock-only-date-container { visibility: visible; }
        body.clock-only-mode.show-weather #clock-only-weather-container { visibility: visible; }
        
        #clock-only-overlay #digital-clock.seconds-visible .clock-segment span { font-size: 22vmin; }
        #clock-only-overlay #digital-clock.seconds-visible .clock-separator { font-size: 18vmin; }
        #clock-only-overlay #digital-clock .clock-segment span { font-size: 30vmin; }
        #clock-only-overlay #digital-clock .clock-separator { font-size: 24vmin; }

        #settings-container { position: fixed; top: 1.5rem; right: 1.5rem; z-index: 100; }
        #settings-toggle { cursor: pointer; width: 2.5rem; height: 2.5rem; background: none; border: none; padding: 0; font-size: 2rem; line-height: 1; color: var(--text-primary); transition: transform 0.2s ease; }
        #settings-toggle:hover { transform: scale(1.1); }
        #settings-panel { display: block; position: absolute; top: 3.5rem; right: 0; background: rgba(30,30,30,0.8); backdrop-filter: blur(var(--ui-blur)); -webkit-backdrop-filter: blur(var(--ui-blur)); border: 1px solid rgba(255,255,255,0.2); border-radius: 0.5rem; padding: 0.7rem; width: 16rem; opacity: 0; transform: translateY(-10px); pointer-events: none; transition: opacity 0.2s ease, transform 0.2s ease; }
        #settings-panel.show { opacity: 1; transform: translateY(0); pointer-events: auto; }
        
        .settings-btn { display: block; width: 100%; background: rgba(51,51,51,0.8); color: var(--text-primary); border: none; padding: 0.7rem; margin-bottom: 0.4rem; border-radius: 0.3rem; cursor: pointer; font-size: 1rem; text-align: left; transition: all 0.2s ease;}
        .settings-btn:hover { background: rgba(68,68,68,0.9); transform: scale(1.02); }
        .settings-group-toggle { font-weight: 700; background: rgba(80,80,80,0.8); }
        .settings-group-toggle::after { content: '▸'; float: right; transition: transform 0.2s ease; }
        .settings-group.open .settings-group-toggle::after { transform: rotate(90deg); }
        .settings-submenu { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; }
        .settings-group.open .settings-submenu { max-height: 500px; /* Giá trị đủ lớn */ }
        .settings-submenu .settings-btn { background-color: rgba(68,68,68,0.7); padding-left: 2rem; font-size: 0.9rem;}
        .settings-submenu .settings-btn:hover { background: rgba(85,85,85,0.9); }
        #reset-settings-btn { background-color: #c0392b; }
        
        .dialog-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 200; justify-content: center; align-items: center; }
        .dialog-overlay.show { display: flex; }
        .dialog-box { background: rgba(30,30,30,0.8); backdrop-filter: blur(var(--ui-blur)); -webkit-backdrop-filter: blur(var(--ui-blur)); border: 1px solid rgba(255,255,255,0.2); padding: 2rem; border-radius: 2vmin; text-align: left; max-width: 500px; width: 90%; }
        .dialog-box h3 { margin-top: 0; color: var(--text-secondary); }
        .dialog-box ul { padding-left: 20px; } .dialog-box li { margin-bottom: 10px; }

        @media (max-width: 800px) {
            .container { flex-direction: column; }
            .info-column, .qr-column { width: 100%; flex-basis: auto; margin-right: 0; }
            .info-column { height: 60%; }
            .qr-column { height: 40%; display: flex; background: none; border: none; backdrop-filter: none; -webkit-backdrop-filter: none;}
            .shop-name { font-size: 2.5rem; } .shop-address { font-size: 1.5rem; }
            
            .clock-segment span { font-size: 20vw; }
            #digital-clock.seconds-visible .clock-segment span { font-size: 15vw; }
            .clock-separator { font-size: 18vw; }
            #digital-clock.seconds-visible .clock-separator { font-size: 13vw; }
            
            .date-container, #weather-container { font-size: 1.8rem; }
            #calendar-container { font-size: 1.2rem; max-width: 90%; }
            #clock-only-date-container, #clock-only-weather-container { font-size: 5vw; }
            #clock-only-overlay #digital-clock-wrapper { flex-grow: 0; }
            #clock-only-overlay #digital-clock .clock-segment span { font-size: 32vw; }
            #clock-only-overlay #digital-clock .clock-separator { font-size: 26vw; }
            #clock-only-overlay #digital-clock.seconds-visible .clock-segment span { font-size: 24vw; }
        }
    </style>
</head>
<body>
    <div id="background-container">
        <img id="background-image" src="" alt="Background Image">
    </div>

    <div class="container" id="main-container">
        <div class="info-column" id="info-column">
            <div class="content-wrapper">
                <div id="digital-clock-wrapper" class="flex-grow-item">
                    </div>
                <div id="date-weather-group" class="flex-grow-item">
                    <div id="date-container" class="date-container"><p id="gregorian-date-p"></p><p id="lunar-date-p"></p><p id="lunar-event"></p></div>
                    <div id="weather-container">
                        <div id="weather-location"></div>
                        <div id="weather-container-line2">
                            <span id="weather-icon"></span>
                            <span id="weather-temp"></span>
                            <span id="weather-desc">Đang tải thời tiết...</span>
                        </div>
                    </div>
                </div>
                <div id="calendar-wrapper" class="flex-grow-item">
                     <div id="calendar-container">
                        <div id="calendar-header"><div class="calendar-nav" id="prev-btn">&lt;</div><div id="calendar-title"></div><div class="calendar-nav" id="next-btn">&gt;</div></div>
                        <div id="calendar-grid"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="qr-column">
            <div class="qr-wrapper" id="qr-wrapper-desktop">
                <img class="qr-code-image" id="qr-code-image-desktop" src="" alt="Mã QR">
                <div class="shop-info">
                    <p class="shop-name" id="shop-name-desktop"></p>
                    <p class="shop-address" id="shop-address-desktop"></p>
                </div>
            </div>
        </div>
    </div>
    
    <div id="digital-clock">
        <div class="clock-segment"><span id="clock-hours">00</span></div><div id="main-colon" class="clock-separator">:</div><div class="clock-segment"><span id="clock-minutes">00</span></div>
        <div class="clock-seconds">
            <div class="clock-separator">:</div><div class="clock-segment"><span id="clock-seconds">00</span></div>
        </div>
    </div>

    <div id="clock-only-overlay">
        <div id="clock-only-weather-container">
             <div id="weather-location-overlay"></div>
             <div id="clock-only-weather-container-line2">
                <span id="weather-icon-overlay"></span>&nbsp;
                <span id="weather-temp-overlay"></span>
             </div>
        </div>
        <div id="clock-only-clock-wrapper"></div>
        <div id="clock-only-date-container">
            <p id="gregorian-date-overlay"></p>
            <p id="lunar-date-overlay" style="color: #f39c12;"></p>
        </div>
    </div>
    
    <div id="settings-container">
        <button id="settings-toggle" aria-label="Mở hoặc đóng bảng cài đặt"><span>&#9776;</span></button>
        <div id="settings-panel">
            
            <div class="settings-group">
                <button class="settings-btn settings-group-toggle">Chế độ hiển thị</button>
                <div class="settings-submenu">
                    <button class="settings-btn" id="clock-only-toggle">Chế độ nhìn xa</button>
                    <button class="settings-btn" id="power-save-toggle">Tiết kiệm điện</button>
                    <button class="settings-btn" id="fullscreen-toggle">Toàn màn hình</button>
                </div>
            </div>

            <div class="settings-group">
                <button class="settings-btn settings-group-toggle">Bố cục & Giao diện</button>
                <div class="settings-submenu">
                    <button class="settings-btn" id="online-photos-toggle">Dùng ảnh online</button>
                    <button class="settings-btn" id="slideshow-toggle">Ẩn các khối</button>
                    <button class="settings-btn" id="shop-toggle-btn">Ẩn Shop</button>
                    <button class="settings-btn" id="qr-toggle-btn">Ẩn Mã QR</button>
                    <button class="settings-btn" id="seconds-toggle">Hiện giây</button>
                    <button class="settings-btn" id="date-toggle">Ẩn Ngày tháng</button>
                    <button class="settings-btn" id="calendar-toggle">Ẩn Lịch</button>
                    <button class="settings-btn" id="weather-toggle">Ẩn Thời tiết</button>
                </div>
            </div>
            
             <div class="settings-group">
                <button class="settings-btn settings-group-toggle">CĐ Nhìn xa</button>
                <div class="settings-submenu">
                    <button class="settings-btn" id="clock-only-gregorian-toggle">Hiện Dương lịch</button>
                    <button class="settings-btn" id="clock-only-lunar-toggle">Hiện Âm lịch</button>
                    <button class="settings-btn" id="clock-only-weather-toggle">Hiện Thời tiết</button>
                </div>
            </div>

            <hr style="border-color: #444; margin: 10px 0;">
            
            <button class="settings-btn" id="refresh-photos-btn">Ảnh mới ngay</button>
            <button class="settings-btn" id="photo-guide-btn">HD: Cập nhật ảnh</button>
            <button class="settings-btn" id="always-on-guide-btn">HD: Giữ màn hình bật</button>
            
            <hr style="border-color: #444; margin: 10px 0;">
            <button class="settings-btn" id="reset-settings-btn">Đặt lại Cài đặt</button>

        </div>
    </div>
    
    <div id="guide-dialog" class="dialog-overlay">
        <div class="dialog-box">
            <h3 id="guide-title"></h3>
            <div id="guide-content"></div>
        </div>
    </div>
    
    <script>
    // ----- THUẬT TOÁN ÂM LỊCH MỚI, CHÍNH XÁC CHO VIỆT NAM (UTC+7) -----
    function solarToLunar(dd, mm, yy) {
        var CAN = ["Canh", "Tân", "Nhâm", "Quý", "Giáp", "Ất", "Bính", "Đinh", "Mậu", "Kỷ"];
        var CHI = ["Thân", "Dậu", "Tuất", "Hợi", "Tý", "Sửu", "Dần", "Mão", "Thìn", "Tỵ", "Ngọ", "Mùi"];
        var LUNAR_INFO = [
            [1, 2, 2, 34824], [1, 2, 1, 35140], [2, 1, 1, 35456], [1, 2, 1, 35748], [1, 1, 1, 36019], [2, 1, 2, 36302], [1, 1, 2, 36585], [1, 1, 1, 36838], [2, 2, 1, 37150], [1, 2, 1, 37443], [1, 2, 1, 37702], [2, 1, 1, 38014], [1, 1, 1, 38292], [2, 2, 1, 38575], [1, 2, 1, 38868], [1, 1, 2, 39155], [2, 1, 2, 39442], [1, 1, 2, 39701], [2, 1, 1, 40013], [1, 2, 1, 40285], [2, 1, 1, 40582], [1, 2, 2, 40898], [1, 2, 1, 41191], [2, 1, 1, 41478], [1, 2, 1, 41775], [1, 2, 1, 42053], [2, 1, 2, 42349], [1, 1, 2, 42613], [2, 1, 1, 42894], [1, 2, 1, 43188], [1, 2, 1, 43447], [2, 1, 1, 43734], [1, 2, 1, 44030], [2, 2, 1, 44335], [1, 2, 1, 44612], [2, 1, 2, 44899], [1, 1, 2, 45186], [2, 1, 1, 45455], [1, 2, 1, 45749], [1, 1, 1, 46006], [2, 1, 2, 46294], [1, 1, 2, 46558], [2, 1, 1, 46845], [1, 2, 1, 47139], [1, 1, 1, 47396], [2, 2, 1, 47691], [1, 2, 2, 47970], [1, 2, 1, 48263], [2, 1, 1, 48532], [1, 2, 1, 48827], [2, 1, 1, 49096], [2, 1, 2, 49383], [1, 2, 1, 49678], [1, 1, 2, 49942], [2, 1, 2, 50225], [1, 1, 1, 50494], [2, 1, 1, 50788], [1, 2, 1, 51066], [2, 1, 2, 51358], [1, 2, 1, 51652], [1, 1, 1, 51910], [2, 2, 1, 52206], [1, 2, 1, 52483], [2, 1, 1, 52778], [1, 1, 1, 53074], [2, 1, 2, 53361], [1, 1, 2, 53630], [2, 1, 2, 53925], [1, 2, 1, 54203], [1, 1, 1, 54487], [2, 1, 1, 54774], [1, 2, 2, 55070], [1, 2, 1, 55348], [2, 1, 1, 55635], [1, 2, 1, 55931], [1, 1, 2, 56201], [2, 1, 2, 56494], [1, 1, 2, 56758], [2, 1, 1, 57045], [1, 2, 1, 57339], [1, 1, 1, 57596], [2, 2, 1, 57891], [1, 2, 2, 58170], [1, 2, 1, 58463], [2, 1, 1, 58732], [1, 2, 1, 59027], [2, 1, 1, 59296], [2, 1, 2, 59583], [1, 2, 1, 59878], [1, 1, 2, 60142], [2, 1, 2, 60425], [1, 1, 1, 60694], [2, 1, 1, 60988], [1, 2, 1, 61266], [2, 1, 2, 61558], [1, 2, 1, 61852], [1, 1, 1, 62110], [2, 2, 1, 62406], [1, 2, 1, 62683], [2, 1, 1, 62978], [1, 1, 1, 63274], [2, 1, 2, 63561], [1, 1, 2, 63830], [2, 1, 2, 64125], [1, 2, 1, 64403], [1, 1, 1, 64687], [2, 1, 1, 64974], [1, 2, 2, 65270], [1, 2, 1, 65548], [2, 1, 1, 65835], [1, 2, 1, 66131], [1, 1, 2, 66401], [2, 1, 2, 66694], [1, 1, 2, 66958], [2, 1, 1, 67245], [1, 2, 1, 67539], [1, 1, 1, 67796], [2, 2, 1, 68091], [1, 2, 2, 68370], [1, 2, 1, 68663], [2, 1, 1, 68932], [1, 2, 1, 69227], [2, 1, 1, 69496], [2, 1, 2, 69783], [1, 2, 1, 70078], [1, 1, 2, 70342], [2, 1, 2, 70625], [1, 1, 1, 70894], [2, 1, 1, 71188], [1, 2, 1, 71466], [2, 1, 2, 71758], [1, 2, 1, 72052], [1, 1, 1, 72310], [2, 2, 1, 72606], [1, 2, 1, 72883], [2, 1, 1, 73178], [1, 1, 1, 73474], [2, 1, 2, 73761], [1, 1, 2, 74030], [2, 1, 2, 74325], [1, 2, 1, 74603], [1, 1, 1, 74887], [2, 1, 1, 75174], [1, 2, 2, 75470], [1, 2, 1, 75748], [2, 1, 1, 76035], [1, 2, 1, 76331], [1, 1, 2, 76601], [2, 1, 2, 76894], [1, 1, 2, 77158], [2, 1, 1, 77445], [1, 2, 1, 77739], [1, 1, 1, 77996], [2, 2, 1, 78291], [1, 2, 2, 78570], [1, 2, 1, 78863], [2, 1, 1, 79132], [1, 2, 1, 79427], [2, 1, 1, 79696], [2, 1, 2, 79983], [1, 2, 1, 80278], [1, 1, 2, 80542], [2, 1, 2, 80825], [1, 1, 1, 81094], [2, 1, 1, 81388], [1, 2, 1, 81666], [2, 1, 2, 81958], [1, 2, 1, 82252], [1, 1, 1, 82510], [2, 2, 1, 82806], [1, 2, 1, 83083], [2, 1, 1, 83378], [1, 1, 1, 83674], [2, 1, 2, 83961], [1, 1, 2, 84230], [2, 1, 2, 84525], [1, 2, 1, 84803], [1, 1, 1, 85087], [2, 1, 1, 85374], [1, 2, 2, 85670], [1, 2, 1, 85948], [2, 1, 1, 86235], [1, 2, 1, 86531], [1, 1, 2, 86801], [2, 1, 2, 87094], [1, 1, 2, 87358], [2, 1, 1, 87645], [1, 2, 1, 87939], [1, 1, 1, 88196], [2, 2, 1, 88491], [1, 2, 2, 88770], [1, 2, 1, 89063], [2, 1, 1, 89332], [1, 2, 1, 89627], [2, 1, 1, 89896], [2, 1, 2, 90183], [1, 2, 1, 90478], [1, 1, 2, 90742], [2, 1, 2, 91025], [1, 1, 1, 91294], [2, 1, 1, 91588], [1, 2, 1, 91866], [2, 1, 2, 92158], [1, 2, 1, 92452], [1, 1, 1, 92710], [2, 2, 1, 93006], [1, 2, 1, 93283], [2, 1, 1, 93578], [1, 1, 1, 93874], [2, 1, 2, 94161], [1, 1, 2, 94430], [2, 1, 2, 94725], [1, 2, 1, 95003], [1, 1, 1, 95287], [2, 1, 1, 95574], [1, 2, 2, 95870], [1, 2, 1, 96148], [2, 1, 1, 96435], [1, 2, 1, 96731], [1, 1, 2, 97001], [2, 1, 2, 97294], [1, 1, 2, 97558], [2, 1, 1, 97845], [1, 2, 1, 98139], [1, 1, 1, 98396], [2, 2, 1, 98691], [1, 2, 2, 98970], [1, 2, 1, 99263], [2, 1, 1, 99532], [1, 2, 1, 99827]];
        function getLunarYearDays(y) { return (LUNAR_INFO[y-1900][3] & 0x10000) ? 366 : 365; }
        function getLunarMonth(y) { return LUNAR_INFO[y-1900].slice(0, 3); }
        function jdFromDate(d, m, y) {
            if (y < 1900 || y > 2100) return 0;
            var j1, j2;
            if (m < 3) { y--; m += 12; }
            j1 = Math.floor(365.25 * y);
            j2 = Math.floor(30.6001 * (m + 1));
            return j1 + j2 + d + 1720995;
        }
        var jd = jdFromDate(dd, mm, yy);
        var h = (new Date()).getHours();
        var Z = 7;
        var day = jd - 2415021 + (h-Z)/24;
        var y;
        for (y=1900; y<=2100; y++) {
            var yd = getLunarYearDays(y);
            if (day < yd) break;
            day -= yd;
        }
        var lunarMonthInfo = getLunarMonth(y);
        var leapMonth = lunarMonthInfo[0];
        var isLeap = false;
        var daysInMonth;
        var i;
        for (i=1; i<13; i++) {
            if (leapMonth === i) {
                daysInMonth = 384 - (LUNAR_INFO[y-1900][3] & 0x7FFF);
                if (day < daysInMonth) { isLeap = true; break; }
                day -= daysInMonth;
            }
            daysInMonth = (lunarMonthInfo[1] === i || lunarMonthInfo[2] === i) ? 30 : 29;
            if (day < daysInMonth) break;
            day -= daysInMonth;
        }
        var lunarDay = Math.floor(day + 1);
        var lunarMonth = i;
        var lunarYear = y;
        var jdToday = jdFromDate(dd, mm, yy);
        var dayCanChi = CAN[(jdToday + 9) % 10] + " " + CHI[(jdToday + 1) % 12];
        var monthName = "tháng " + lunarMonth + (isLeap ? " nhuận" : "");
        var yearName = "năm " + CAN[(lunarYear-4)%10] + " " + CHI[(lunarYear-4)%12];

        return { day: lunarDay, lunarMonth: lunarMonth, lunarYear: lunarYear, isLeap: isLeap, dayCanChi: dayCanChi, monthName: monthName, yearName: yearName };
    }
    
    document.addEventListener("DOMContentLoaded", function() {
        var REMOTE_IMAGE_MANIFEST_URL = 'https://gist.githubusercontent.com/anlvdt/66f712365351cc8cfc2ad27718b2c9d7/raw/c2cdaa42b282b28e8024417771f314e421b074a7/slideshow_images.json';
        var REMOTE_CONFIG_URL = 'https://gist.githubusercontent.com/anlvdt/5ba20e2a08249bcac84aca7f2c371f0b/raw/7470ffdaf1a0dc18306599033555bf029073858e/config.json';

        var els = { container: document.getElementById('main-container'), clockOnlyOverlay: document.getElementById('clock-only-overlay'), infoColumn: document.getElementById('info-column'), clock: document.getElementById('digital-clock'), digitalClockWrapper: document.getElementById('digital-clock-wrapper'), clockOnlyClockWrapper: document.getElementById('clock-only-clock-wrapper'), mainColon: document.getElementById('main-colon'), dateWeatherGroup: document.getElementById('date-weather-group'), calendarWrapper: document.getElementById('calendar-wrapper'), weatherLocation: document.getElementById('weather-location'), weatherIcon: document.getElementById('weather-icon'), weatherTemp: document.getElementById('weather-temp'), weatherDesc: document.getElementById('weather-desc'), prevBtn: document.getElementById('prev-btn'), nextBtn: document.getElementById('next-btn'), backgroundImage: document.getElementById('background-image'), settingsToggle: document.getElementById('settings-toggle'), settingsPanel: document.getElementById('settings-panel'), slideshowToggleBtn: document.getElementById('slideshow-toggle'), shopToggleBtn: document.getElementById('shop-toggle-btn'), qrToggleBtn: document.getElementById('qr-toggle-btn'), secondsBtn: document.getElementById('seconds-toggle'), dateToggleBtn: document.getElementById('date-toggle'), calendarToggleBtn: document.getElementById('calendar-toggle'), weatherToggleBtn: document.getElementById('weather-toggle'), fullscreenBtn: document.getElementById('fullscreen-toggle'), resetSettingsBtn: document.getElementById('reset-settings-btn'), refreshPhotosBtn: document.getElementById('refresh-photos-btn'), photoGuideBtn: document.getElementById('photo-guide-btn'), alwaysOnGuideBtn: document.getElementById('always-on-guide-btn'), guideDialog: document.getElementById('guide-dialog'), guideTitle: document.getElementById('guide-title'), guideContent: document.getElementById('guide-content'), clockOnlyToggleBtn: document.getElementById('clock-only-toggle'), clockOnlyGregorianBtn: document.getElementById('clock-only-gregorian-toggle'), clockOnlyLunarBtn: document.getElementById('clock-only-lunar-toggle'), gregorianDateOverlay: document.getElementById('gregorian-date-overlay'), lunarDateOverlay: document.getElementById('lunar-date-overlay'), onlinePhotosBtn: document.getElementById('online-photos-toggle'), clockOnlyWeatherBtn: document.getElementById('clock-only-weather-toggle'), weatherLocationOverlay: document.getElementById('weather-location-overlay'), weatherIconOverlay: document.getElementById('weather-icon-overlay'), weatherTempOverlay: document.getElementById('weather-temp-overlay'), powerSaveBtn: document.getElementById('power-save-toggle') };
        var images = [], currentImageIndex = 0, slideshowInterval = null, currentDateForCalendar = new Date(), lastTime = {};
        var settings = { slideshowHidden: false, shopHidden: false, qrHidden: false, secondsVisible: false, dateHidden: false, calendarHidden: false, weatherHidden: false, clockOnlyMode: false, clockOnlyShowGregorian: false, clockOnlyShowLunar: false, clockOnlyShowWeather: false, useOnlinePhotos: false, powerSaveMode: false };
        
        function updateClock() { var now = new Date(); var h = ('0' + now.getHours()).slice(-2); var m = ('0' + now.getMinutes()).slice(-2); var s = ('0' + now.getSeconds()).slice(-2); if (lastTime.h !== h) { document.getElementById('clock-hours').textContent = h; lastTime.h = h; } if (lastTime.m !== m) { document.getElementById('clock-minutes').textContent = m; lastTime.m = m; } if (settings.secondsVisible) { document.getElementById('clock-seconds').textContent = s; } }
        function updateMainDate() { var now = new Date(); var dayOfWeek = ["Chủ Nhật", "Thứ Hai", "Thứ Ba", "Thứ Tư", "Thứ Năm", "Thứ Sáu", "Thứ Bảy"]; var gregorianText = dayOfWeek[now.getDay()] + ', ngày ' + now.getDate() + ' tháng ' + (now.getMonth() + 1) + ' năm ' + now.getFullYear(); var lunar = solarToLunar(now.getDate(), now.getMonth() + 1, now.getFullYear()); var lunarText = 'Âm lịch: ' + lunar.dayCanChi + ', ngày ' + lunar.day + ' ' + lunar.monthName; document.getElementById('gregorian-date-p').innerText = gregorianText; document.getElementById('lunar-date-p').innerText = lunarText; els.gregorianDateOverlay.innerText = gregorianText; els.lunarDateOverlay.innerText = lunarText; var eventText = ""; if (lunar.day === 1) eventText = "Mồng 1"; else if (lunar.day === 15) eventText = "Ngày Rằm"; document.getElementById('lunar-event').innerText = eventText; }
        function makeRequest(url, callback) { var xhr = new XMLHttpRequest(); xhr.onreadystatechange = function() { if (xhr.readyState === 4) { if (xhr.status >= 200 && xhr.status < 300) { try { callback(null, JSON.parse(xhr.responseText)); } catch(e) { callback(e, null); } } else { callback(new Error('Yêu cầu mạng thất bại: ' + xhr.status), null); } } }; xhr.open('GET', url, true); xhr.send(); }
        
        function getWeatherInfoFromWttr(code) { var map = { "395":{d:"Tuyết và dông",i:"🌨️"},"392":{d:"Tuyết nhẹ và dông",i:"🌨️"},"389":{d:"Mưa và dông",i:"⛈️"},"386":{d:"Mưa nhẹ và dông",i:"⛈️"},"377":{d:"Mưa đá",i:"🌨️"},"374":{d:"Mưa đá nhỏ",i:"🌨️"},"368":{d:"Mưa tuyết nhẹ",i:"🌨️"},"359":{d:"Mưa lớn",i:"🌧️"},"356":{d:"Mưa rào lớn",i:"🌧️"},"353":{d:"Mưa rào nhẹ",i:"🌦️"},"350":{d:"Mưa đá",i:"🌨️"},"338":{d:"Tuyết dày",i:"🌨️"},"335":{d:"Tuyết rơi dày",i:"🌨️"},"332":{d:"Tuyết",i:"❄️"},"329":{d:"Tuyết vừa",i:"❄️"},"326":{d:"Tuyết nhẹ",i:"❄️"},"323":{d:"Tuyết nhẹ",i:"❄️"},"320":{d:"Mưa tuyết",i:"🌨️"},"317":{d:"Mưa tuyết nhẹ",i:"🌨️"},"314":{d:"Mưa phùn lạnh",i:"🌨️"},"311":{d:"Mưa phùn lạnh",i:"🌨️"},"308":{d:"Mưa lớn",i:"🌧️"},"305":{d:"Mưa lớn",i:"🌧️"},"302":{d:"Mưa vừa",i:"🌧️"},"299":{d:"Mưa vừa",i:"🌧️"},"296":{d:"Mưa nhẹ",i:"🌦️"},"293":{d:"Mưa nhẹ",i:"🌦️"},"284":{d:"Mưa phùn lạnh",i:"🌨️"},"281":{d:"Mưa phùn lạnh",i:"🌨️"},"266":{d:"Mưa phùn nhẹ",i:"🌦️"},"263":{d:"Mưa phùn nhẹ",i:"🌦️"},"260":{d:"Sương mù",i:"🌫️"},"248":{d:"Sương mù",i:"🌫️"},"230":{d:"Bão tuyết",i:"🌨️"},"227":{d:"Tuyết bay",i:"🌨️"},"200":{d:"Dông",i:"⚡"},"185":{d:"Mưa phùn lạnh",i:"🌨️"},"182":{d:"Mưa tuyết nhẹ",i:"🌨️"},"179":{d:"Tuyết nhẹ",i:"❄️"},"176":{d:"Mưa rào",i:"🌦️"},"143":{d:"Sương mù",i:"🌫️"},"122":{d:"Nhiều mây",i:"☁️"},"119":{d:"Nhiều mây",i:"☁️"},"116":{d:"Mây rải rác",i:"🌥️"},"113":{d:"Trời quang",i:"☀️"}}; return map[code] || {d:"Không xác định", i:"🤷"}; }
        function loadAutomaticWeather() {
            makeRequest('https://ipinfo.io/json', function(err, data) {
                if (err || !data || !data.city) {
                    console.error("Lỗi xác định vị trí:", err);
                    els.weatherDesc.textContent = "Lỗi vị trí";
                    return;
                }
                var city = data.city;
                var weatherUrl = 'https://wttr.in/' + encodeURIComponent(city) + '?format=j1';
                makeRequest(weatherUrl, function(err, weatherData){
                    if(err || !weatherData){
                        console.error("Lỗi tải thời tiết từ wttr.in:", err);
                        els.weatherDesc.textContent = "Lỗi thời tiết";
                        return;
                    }
                    var current = weatherData.current_condition[0];
                    var info = getWeatherInfoFromWttr(current.weatherCode);
                    
                    els.weatherLocation.textContent = city;
                    els.weatherIcon.textContent = info.i;
                    els.weatherTemp.textContent = current.temp_C + "°C";
                    els.weatherDesc.textContent = info.d;

                    els.weatherLocationOverlay.textContent = city;
                    els.weatherIconOverlay.textContent = info.i;
                    els.weatherTempOverlay.textContent = current.temp_C + "°C";
                });
            });
        }

        function fetchOnlinePhoto(callback) {
            var apiUrl = 'https://picsum.photos/1920/1080';
            var uniqueUrl = apiUrl + '?t=' + new Date().getTime();
            
            var tempImg = new Image();
            tempImg.onload = function() {
                els.backgroundImage.src = tempImg.src;
                if(callback) callback();
            };
            tempImg.onerror = function() { 
                console.error("Lỗi tải ảnh từ Picsum Photos.");
                if(callback) callback();
            };
            tempImg.src = uniqueUrl;
        }

        function fetchAndUpdateRemoteImages(callback) { 
            if (settings.useOnlinePhotos) {
                fetchOnlinePhoto(callback);
            } else {
                makeRequest(REMOTE_IMAGE_MANIFEST_URL + '?t=' + new Date().getTime(), function(err, data) { 
                    if (err || !Array.isArray(data) || data.length === 0) { 
                        console.error("Lỗi tải hoặc danh sách ảnh trống.");
                        images = []; 
                        els.backgroundImage.classList.remove('loaded');
                        els.backgroundImage.src='';
                    } else {
                        images = data;
                        currentImageIndex = -1; 
                        changeImage();
                    }
                    if(callback) callback();
                }); 
            }
        }
        function fetchRemoteConfig() { makeRequest(REMOTE_CONFIG_URL + '?t=' + new Date().getTime(), function(err, data) { if (err || !data) { console.error("Lỗi tải cấu hình QR.", err); data = {}; } var qrUrl = data.qrImageUrl || ""; var shopName = data.shopName || "Tên Cửa Hàng"; var shopAddress = data.shopAddress || "Địa chỉ cửa hàng"; document.getElementById('qr-code-image-desktop').src = qrUrl; document.getElementById('shop-name-desktop').textContent = shopName; document.getElementById('shop-address-desktop').textContent = shopAddress; els.container.querySelector('.qr-wrapper').classList.add('loaded');}); }
        
        function changeImage() {
            els.backgroundImage.classList.remove('loaded');
            setTimeout(function() {
                if (settings.useOnlinePhotos) {
                    fetchOnlinePhoto();
                } else {
                    if (!images || images.length === 0) return;
                    currentImageIndex = (currentImageIndex + 1) % images.length; 
                    els.backgroundImage.src = images[currentImageIndex];
                }
            }, 1000);
        }

        function startSlideshow() { 
            if(slideshowInterval) clearInterval(slideshowInterval);
            slideshowInterval = setInterval(changeImage, 12000);
        }
        
        function saveSettings() { try { localStorage.setItem('dashboardSettings', JSON.stringify(settings)); } catch (e) { console.error("Không thể lưu cài đặt:", e); } }
        
        function applySettings() {
            document.body.classList.toggle('power-save-mode', settings.powerSaveMode);
            document.body.classList.toggle('clock-only-mode', settings.clockOnlyMode);

            if (settings.clockOnlyMode) {
                els.clockOnlyClockWrapper.appendChild(els.clock);
                els.clockOnlyOverlay.classList.toggle('show-dates', settings.clockOnlyShowGregorian || settings.clockOnlyShowLunar);
                els.clockOnlyOverlay.classList.toggle('show-weather', settings.clockOnlyShowWeather);
            } else {
                els.digitalClockWrapper.appendChild(els.clock);
            }
            
            els.container.classList.toggle('slideshow-hidden', settings.slideshowHidden);
            els.container.classList.toggle('shop-hidden', settings.shopHidden);
            els.container.classList.toggle('qr-hidden', settings.qrHidden);
            
            els.clock.classList.toggle('seconds-visible', settings.secondsVisible);
            els.mainColon.classList.toggle('colon-blinking', !settings.secondsVisible);

            els.slideshowToggleBtn.textContent = settings.slideshowHidden ? 'Hiện các khối' : 'Ẩn các khối';
            els.onlinePhotosBtn.textContent = settings.useOnlinePhotos ? 'Dùng ảnh cá nhân' : 'Dùng ảnh online';
            els.powerSaveBtn.textContent = settings.powerSaveMode ? 'Tắt Tiết kiệm điện' : 'Bật Tiết kiệm điện';
            els.shopToggleBtn.textContent = settings.shopHidden ? 'Hiện Shop' : 'Ẩn Shop';
            els.qrToggleBtn.textContent = settings.qrHidden ? 'Hiện Mã QR' : 'Ẩn Mã QR';
            els.secondsBtn.textContent = settings.secondsVisible ? 'Ẩn giây' : 'Hiện giây';
            els.calendarWrapper.classList.toggle('hidden-force', settings.calendarHidden); 
            els.calendarToggleBtn.textContent = settings.calendarHidden ? 'Hiện Lịch' : 'Ẩn Lịch';
            
            document.getElementById('date-container').classList.toggle('hidden-force', settings.dateHidden);
            document.getElementById('weather-container').classList.toggle('hidden-force', settings.weatherHidden);
            els.dateWeatherGroup.classList.toggle('hidden-force', settings.dateHidden && settings.weatherHidden);
            
            els.dateToggleBtn.textContent = settings.dateHidden ? 'Hiện Ngày tháng' : 'Ẩn Ngày tháng';
            els.weatherToggleBtn.textContent = settings.weatherHidden ? 'Hiện Thời tiết' : 'Ẩn Thời tiết';
            els.clockOnlyToggleBtn.textContent = settings.clockOnlyMode ? 'Thoát CĐ nhìn xa' : 'Chế độ nhìn xa';
            els.clockOnlyGregorianBtn.textContent = settings.clockOnlyShowGregorian ? 'Tắt Dương lịch' : 'Bật Dương lịch';
            els.clockOnlyLunarBtn.textContent = settings.clockOnlyShowLunar ? 'Tắt Âm lịch' : 'Bật Âm lịch';
            els.clockOnlyWeatherBtn.textContent = settings.clockOnlyShowWeather ? 'Tắt Thời tiết' : 'Bật Thời tiết';
        }
        
        function loadSettings() { try { var savedSettings = localStorage.getItem('dashboardSettings'); if (savedSettings) { settings = Object.assign(settings, JSON.parse(savedSettings)); } } catch (e) { console.error("Không thể tải cài đặt:", e); } applySettings(); }
        function updateLayout() { renderCalendar(); }
        function renderCalendar() { var isVertical = window.innerWidth <= 800; var calendarFn = isVertical ? generateMonthlyCalendar : generateWeeklyCalendar; calendarFn(currentDateForCalendar); }
        function generateWeeklyCalendar(baseDate) { var grid=document.getElementById('calendar-grid');grid.innerHTML='';var today=new Date();var dayNames=['CN','T2','T3','T4','T5','T6','T7'];var weekStart=new Date(baseDate);weekStart.setDate(baseDate.getDate()-baseDate.getDay());var weekEnd=new Date(weekStart);weekEnd.setDate(weekStart.getDate()+6);document.getElementById('calendar-title').textContent='Tuần: '+weekStart.getDate()+'/'+(weekStart.getMonth()+1)+' - '+weekEnd.getDate()+'/'+(weekEnd.getMonth()+1);dayNames.forEach(function(name){var dayEl=document.createElement('div');dayEl.className='calendar-cell day-name';dayEl.innerHTML='<div class="cell-content">'+name+'</div>';grid.appendChild(dayEl);});for(var i=0;i<7;i++){var currentDay=new Date(weekStart);currentDay.setDate(weekStart.getDate()+i);var solarDay=currentDay.getDate();var lunar=solarToLunar(solarDay,currentDay.getMonth()+1,currentDay.getFullYear());var lunarDisplay=lunar.day===1?lunar.day+'/'+lunar.lunarMonth:lunar.day;var dayEl=document.createElement('div');dayEl.className='calendar-cell';if(currentDay.getDate()===today.getDate()&&currentDay.getMonth()===today.getMonth()&&currentDay.getFullYear()===today.getFullYear()){dayEl.classList.add('today');}dayEl.innerHTML='<div class="calendar-cell-inner"><div class="cell-content"><span class="solar-day">'+solarDay+'</span><span class="lunar-day">'+lunarDisplay+'</span></div></div>';grid.appendChild(dayEl);} }
        function generateMonthlyCalendar(baseDate) { var grid=document.getElementById('calendar-grid');grid.innerHTML='';var today=new Date();var year=baseDate.getFullYear();var month=baseDate.getMonth();document.getElementById('calendar-title').textContent='Tháng '+(month+1)+' '+year;var firstDayOfMonth=new Date(year,month,1).getDay();var daysInMonth=new Date(year,month+1,0).getDate();var dayNames=['CN','T2','T3','T4','T5','T6','T7'];dayNames.forEach(function(name){var dayEl=document.createElement('div');dayEl.className='calendar-cell day-name';dayEl.innerHTML='<div class="cell-content">'+name+'</div>';grid.appendChild(dayEl);});for(var i=0;i<firstDayOfMonth;i++){var dayEl=document.createElement('div');dayEl.className='calendar-cell other-month';grid.appendChild(dayEl);}for(var i=1;i<=daysInMonth;i++){var solarDay=i;var lunar=solarToLunar(solarDay,month+1,year);var lunarDisplay=lunar.day===1?lunar.day+'/'+lunar.lunarMonth:lunar.day;var dayEl=document.createElement('div');dayEl.className='calendar-cell';if(solarDay===today.getDate()&&month===today.getMonth()&&year===today.getFullYear()){dayEl.classList.add('today');}dayEl.innerHTML='<div class="calendar-cell-inner"><div class="cell-content"><span class="solar-day">'+solarDay+'</span><span class="lunar-day">'+lunarDisplay+'</span></div></div>';grid.appendChild(dayEl);} }
        function showGuide(type) { var guides = { photo: { title: 'Hướng dẫn Cập nhật Ảnh', content: '<ul><li>Bạn có thể dùng danh sách ảnh cá nhân (cấu hình trong file Gist) hoặc dùng ảnh online từ Unsplash.</li><li>Để dùng ảnh online, bạn không cần API Key, chỉ cần bật tùy chọn trong menu. Bạn có thể tùy chỉnh chủ đề ảnh bằng cách sửa các từ khóa trong mã nguồn.</li><li>Sử dụng nút "Dùng ảnh online" trong menu cài đặt để chuyển đổi giữa hai chế độ.</li></ul>' }, alwaysOn: { title: 'Hướng dẫn Giữ Màn hình Bật', content: '<ul><li><b>iPad/iPhone:</b> Vào Cài đặt > Màn hình & Độ sáng > Tự động khoá > chọn "Không".</li><li><b>Android:</b> Vào Cài đặt > Màn hình > Thời gian sáng màn hình > chọn thời gian dài nhất hoặc "Không bao giờ". Một số máy cần bật "Tuỳ chọn nhà phát triển" để có tuỳ chọn "Luôn bật khi sạc".</li><li><b>Windows/macOS:</b> Vào phần cài đặt Năng lượng (Power/Energy Saver) và đặt thời gian tắt màn hình thành "Không bao giờ" (Never).</li></ul>' } }; var guide = guides[type]; els.guideTitle.innerHTML = guide.title; els.guideContent.innerHTML = guide.content; els.guideDialog.classList.add('show'); }
        
        els.prevBtn.addEventListener('click', function() { currentDateForCalendar.setMonth(currentDateForCalendar.getMonth() - 1); renderCalendar(); });
        els.nextBtn.addEventListener('click', function() { currentDateForCalendar.setMonth(currentDateForCalendar.getMonth() + 1); renderCalendar(); });
        window.addEventListener('resize', function() { setTimeout(updateLayout, 200); });
        els.settingsToggle.addEventListener('click', function(e) { e.stopPropagation(); els.settingsPanel.classList.toggle('show'); });
        document.addEventListener('click', function(e) {
            if (els.settingsPanel.classList.contains('show') && !els.settingsPanel.contains(e.target)) {
                els.settingsPanel.classList.remove('show');
            }
        });

        document.querySelectorAll('.settings-group-toggle').forEach(function(button) {
            button.addEventListener('click', function() {
                this.parentElement.classList.toggle('open');
            });
        });

        els.resetSettingsBtn.addEventListener('click', function() { if (confirm('Bạn có chắc muốn đặt lại tất cả cài đặt?')) { localStorage.removeItem('dashboardSettings'); window.location.reload(); } });
        els.fullscreenBtn.addEventListener('click', function() { var docElm = document.documentElement; if (docElm.requestFullscreen) { if (!document.fullscreenElement) { docElm.requestFullscreen(); } else { document.exitFullscreen(); } } else if (docElm.webkitRequestFullscreen) { if (!document.webkitFullscreenElement) { docElm.webkitRequestFullscreen(); } else { document.webkitExitFullscreen(); } } });
        
        var toggleButtons = { slideshowToggleBtn: 'slideshowHidden', shopToggleBtn: 'shopHidden', qrToggleBtn: 'qrHidden', dateToggleBtn: 'dateHidden', calendarToggleBtn: 'calendarHidden', weatherToggleBtn: 'weatherHidden', secondsBtn: 'secondsVisible', clockOnlyToggleBtn: 'clockOnlyMode', clockOnlyGregorianBtn: 'clockOnlyShowGregorian', clockOnlyLunarBtn: 'clockOnlyShowLunar', onlinePhotosBtn: 'useOnlinePhotos', clockOnlyWeatherBtn: 'clockOnlyShowWeather', powerSaveBtn: 'powerSaveMode' };
        for (var btnId in toggleButtons) { (function(id, settingKey) { if(els[id]) { els[id].addEventListener('click', function() { settings[settingKey] = !settings[settingKey]; saveSettings(); applySettings(); if(settingKey === 'useOnlinePhotos'){ if(slideshowInterval) clearInterval(slideshowInterval); fetchAndUpdateRemoteImages(startSlideshow); } }); } })(btnId, toggleButtons[btnId]); }

        els.refreshPhotosBtn.addEventListener('click', function() {
            if(slideshowInterval) clearInterval(slideshowInterval);
            fetchAndUpdateRemoteImages(startSlideshow);
            els.settingsPanel.classList.remove('show');
        });
        els.photoGuideBtn.addEventListener('click', function() { showGuide('photo'); });
        els.alwaysOnGuideBtn.addEventListener('click', function() { showGuide('alwaysOn'); });
        els.guideDialog.addEventListener('click', function(e) { if(e.target === els.guideDialog) { els.guideDialog.classList.remove('show'); } });
        els.backgroundImage.addEventListener('load', function() { this.classList.add('loaded'); });
        els.backgroundImage.onerror = function() { console.warn("Lỗi tải ảnh. Đang thử tải ảnh mới..."); setTimeout(changeImage, 1000); };
        
        loadSettings(); updateClock(); updateMainDate(); updateLayout(); loadAutomaticWeather(); fetchAndUpdateRemoteImages(startSlideshow); fetchRemoteConfig();
        
        setInterval(updateClock, 1000); 
        setInterval(loadAutomaticWeather, 1800000); 
        setInterval(function() { if (!settings.useOnlinePhotos) fetchAndUpdateRemoteImages(); }, 3600000); 
        setInterval(function() { var now = new Date(); if (now.getMinutes() === 0 && now.getSeconds() < 2) { updateMainDate(); currentDateForCalendar = new Date(); renderCalendar(); } }, 1000);
    });
    </script>
</body>
</html>
