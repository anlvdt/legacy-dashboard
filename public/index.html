<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Legacy Frame by An Le - Make old device great again!</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&family=Lato:wght@900&display=swap" rel="stylesheet">
    <style>
        html { font-size: 1.5vmin; }
        @media (max-width: 480px) { html { font-size: 10px; } }
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
        
        body {
            background-color: #000;
            color: #F5F5F5; /* Màu trắng ngà dịu mắt */
            font-family: 'Nunito', sans-serif;
            transition: all 0.5s ease;
        }

        #background-container {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: -1;
        }

        #background-image {
            width: 100%; height: 100%;
            object-fit: cover;
            transition: opacity 1.5s ease-in-out;
            opacity: 0;
        }
        #background-image.loaded {
            opacity: 1;
        }

        .container { 
            display: flex; 
            width: 100%; 
            height: 100%; 
            position: relative;
            padding: 2.5vmin;
            box-sizing: border-box;
        }
        
        .info-column, .qr-column {
            flex: 1 1 0;
            display: flex;
            height: 100%;
            overflow: hidden;
            transition: all 0.5s ease;
        }
        .info-column { flex-grow: 1.2; margin-right: 2.5vmin; }
        .qr-column { flex-grow: 0.8; }

        .content-wrapper { display: flex; flex-direction: column; width: 100%; height: 100%; text-align: center; overflow: hidden; }
        
        .flex-grow-item { display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 0; transition: all 0.4s ease; }
        #digital-clock-wrapper { flex-grow: 1.2; }
        #date-weather-group { flex-grow: 1; flex-direction: column; justify-content: center; }
        #calendar-wrapper { flex-grow: 1.5; }

        .clock-segment {
            background: rgba(28, 28, 28, 0.45);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 2vmin;
            padding: 0.5vmin 2vmin;
            position: relative;
            box-shadow: 0 0.5vmin 2vmin rgba(0,0,0,0.5);
            margin: 0 0.5vmin;
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }
        
        #digital-clock { display: flex; justify-content: center; align-items: center; width: 100%; line-height: 1; }
        .clock-segment span, .clock-separator { font-family: 'Lato', sans-serif; font-weight: 900; color: #F5F5F5; text-shadow: 0 0 1vmin rgba(255,255,255,0.2); transition: font-size 0.3s ease; }
        .clock-segment span { font-size: 13vmin; letter-spacing: 0.05em; }
        .clock-separator { font-size: 10vmin; }
        
        .clock-seconds { display: flex; align-items: center; max-width: 0; opacity: 0; overflow: hidden; transition: max-width 0.5s ease, opacity 0.5s ease; }
        #digital-clock.seconds-visible .clock-segment span { font-size: 8vmin; }
        #digital-clock.seconds-visible .clock-separator { font-size: 7vmin; }
        #digital-clock.seconds-visible .clock-seconds { max-width: 30vmin; opacity: 1; }
        
        @-webkit-keyframes blink { 50% { opacity: 0.3; } }
        @keyframes blink { 50% { opacity: 0.3; } }
        
        .colon-blinking {
            -webkit-animation: blink 1s step-end infinite;
            animation: blink 1s step-end infinite;
        }

        .date-container { font-size: 3.2vmin; margin-bottom: 3vmin; font-weight: 700; text-shadow: 0 2px 5px rgba(0,0,0,0.7); }
        .date-container p { margin: 1vmin 0; }
        #gregorian-date-p { opacity: 0.8; }
        #lunar-date-p { color: #f39c12; }
        #lunar-event { color: #e67e22; min-height: 1em; }
        
        #weather-container { display:flex; justify-content: center; align-items: center; font-weight: 700; text-shadow: 0 2px 5px rgba(0,0,0,0.7); }
        #weather-container > span { margin: 0 0.5rem; }
        #weather-icon { font-size: 4vmin; }
        #weather-location { color: #2980b9; }

        #calendar-container {
            background: rgba(28, 28, 28, 0.45);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1.5vmin;
            border-radius: 2vmin;
            width: 100%;
            max-width: 48vmin;
            box-sizing: border-box;
            margin: 0 auto;
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }
        #calendar-header { display: table; width: 100%; }
        .calendar-nav, #calendar-title { display: table-cell; vertical-align: middle; }
        #calendar-title { width: 70%; font-size: 2vmin; font-weight: 700; }
        .calendar-nav { width: 15%; cursor: pointer; font-size: 2.5vmin; user-select: none; }
        #calendar-grid { margin-top: 1vmin; }
        #calendar-grid::after { content: ""; display: table; clear: both; }
        .calendar-cell { float: left; width: 14.28%; box-sizing: border-box; position: relative; }
        .calendar-cell::before { content: ''; display: block; padding-top: 85%; }
        .calendar-cell-inner { position: absolute; top: 0.2rem; right: 0.2rem; bottom: 0.2rem; left: 0.2rem; display: flex; flex-direction: column; justify-content: center;}
        .cell-content { text-align: center; padding: 0.2rem 0; }
        .day-name .cell-content { font-weight: 700; color: #f39c12; font-size: 1.6vmin; }
        .solar-day { font-size: 1.8vmin; font-weight: 700; display: block; }
        .lunar-day { font-size: 1.3vmin; display: block; color: #f39c12; opacity: 0.8; }
        .other-month { opacity: 0.3; }
        .today .calendar-cell-inner { background-color: #f39c12; color: #000; border-radius: 0.8vmin; font-weight: 700; }
        .today .lunar-day { color: #000; }
        
        .qr-column {
            background: rgba(28, 28, 28, 0.45);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 2vmin;
            padding: 2.5vmin;
            box-sizing: border-box;
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }
        .qr-wrapper { display: flex; flex-direction: column; justify-content: center; align-items: center; width: 100%; height: 100%; opacity: 0; transition: opacity 0.5s ease; }
        .qr-wrapper.loaded { opacity: 1; }
        .qr-code-image { width: 100%; max-width: 300px; height: auto; border-radius: 1vmin; border: 2px solid #fff; margin-bottom: 2vmin; }
        .shop-info { text-align: center; }
        .shop-name { font-family: 'Oswald', sans-serif; font-size: 3.5vmin; font-weight: 700; color: #f39c12; margin: 0; }
        .shop-address { font-size: 2vmin; line-height: 1.4; margin: 1vmin 0 0 0; }
        
        .hidden-force { transition: opacity 0.4s ease, max-height 0.4s ease, margin 0.4s ease, padding 0.4s ease, flex-basis 0.4s ease; opacity: 0 !important; max-height: 0 !important; min-height: 0 !important; margin: 0 !important; padding: 0 !important; overflow: hidden !important; border: none !important; flex-grow: 0 !important; flex-basis: 0 !important; }

        .container.shop-hidden .qr-column, .container.slideshow-hidden .info-column, .container.slideshow-hidden .qr-column { flex-grow: 0; flex-basis: 0; margin: 0 !important; border: none !important; padding: 0 !important;}
        .container.slideshow-hidden .info-column { margin-right: 0; }
        .container.qr-hidden .qr-code-image { display: none; }
        
        #clock-only-date-container { position: absolute; bottom: 3vh; left: 0; right: 0; text-align: center; font-size: 4vmin; display: none; z-index: 10; text-shadow: 0 2px 8px rgba(0,0,0,0.8); font-weight: 700;}
        #clock-only-date-container p { margin: 0.5vmin 0; }
        .container.clock-only-mode { padding: 0; }
        .container.clock-only-mode .info-column { margin-right: 0; }
        .container.clock-only-mode .qr-column,
        .container.clock-only-mode #date-weather-group,
        .container.clock-only-mode #calendar-wrapper,
        .container.clock-only-mode #settings-container { display: none; }
        .container.clock-only-mode.show-dates #clock-only-date-container { display: block; }
        .container.clock-only-mode .clock-segment span { font-size: 35vmin; }
        .container.clock-only-mode .clock-separator { font-size: 28vmin; }
        .container.clock-only-mode #digital-clock.seconds-visible .clock-segment span { font-size: 25vmin; }
        .container.clock-only-mode #digital-clock.seconds-visible .clock-separator { font-size: 20vmin; }

        #settings-container { position: absolute; top: 1.5rem; right: 1.5rem; z-index: 100; }
        #settings-toggle { cursor: pointer; width: 2.5rem; height: 2.5rem; background: none; border: none; padding: 0; font-size: 2rem; line-height: 1; color: #F5F5F5; transition: transform 0.2s ease; }
        #settings-toggle:hover { transform: scale(1.1); }
        #settings-panel { display: block; position: absolute; top: 3.5rem; right: 0; background: rgba(30,30,30,0.8); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.2); border-radius: 0.5rem; padding: 0.7rem; width: 16rem; opacity: 0; transform: translateY(-10px); pointer-events: none; transition: opacity 0.2s ease, transform 0.2s ease; }
        #settings-panel.show { opacity: 1; transform: translateY(0); pointer-events: auto; }
        .settings-btn { display: block; width: 100%; background: rgba(51,51,51,0.8); color: #F5F5F5; border: none; padding: 0.7rem; margin-bottom: 0.4rem; border-radius: 0.3rem; cursor: pointer; font-size: 1rem; text-align: left; transition: all 0.2s ease;}
        .settings-btn:hover { background: rgba(68,68,68,0.9); transform: scale(1.02); }
        .settings-btn.sub-option { background-color: rgba(68,68,68,0.7); padding-left: 2rem;}
        .settings-btn.sub-option:hover { background: rgba(85,85,85,0.9); }
        #reset-settings-btn { background-color: #c0392b; }
        
        .dialog-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 200; justify-content: center; align-items: center; }
        .dialog-overlay.show { display: flex; }
        .dialog-box { background: rgba(30,30,30,0.8); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.2); padding: 2rem; border-radius: 2vmin; text-align: left; max-width: 500px; width: 90%; }
        .dialog-box h3 { margin-top: 0; color: #f39c12; }
        .dialog-box ul { padding-left: 20px; } .dialog-box li { margin-bottom: 10px; }

        @media (max-width: 800px) {
            .container { flex-direction: column; }
            .info-column, .qr-column { width: 100%; flex-basis: auto; margin-right: 0; }
            .info-column { height: 60%; }
            .qr-column { height: 40%; display: flex; background: none; border: none; backdrop-filter: none; -webkit-backdrop-filter: none;}
            .shop-name { font-size: 2.5rem; } .shop-address { font-size: 1.5rem; }
            
            .clock-segment span { font-size: 20vw; }
            #digital-clock.seconds-visible .clock-segment span { font-size: 15vw; }
            .clock-separator { font-size: 18vw; }
            #digital-clock.seconds-visible .clock-separator { font-size: 13vw; }
            
            .date-container, #weather-container { font-size: 1.6rem; }
            #calendar-container { font-size: 1.2rem; max-width: 90%; }
            #clock-only-date-container { font-size: 5vw; }
            .container.clock-only-mode .info-column { height: 100%; }
            .container.clock-only-mode .clock-segment span { font-size: 38vw; }
            .container.clock-only-mode .clock-separator { font-size: 30vw; }
            .container.clock-only-mode #digital-clock.seconds-visible .clock-segment span { font-size: 26vw; }
        }
    </style>
</head>
<body>
    <div id="background-container">
        <img id="background-image" src="" alt="Background Image">
    </div>

    <div class="container" id="main-container">
        <div class="info-column" id="info-column">
            <div class="content-wrapper">
                <div id="digital-clock-wrapper" class="flex-grow-item">
                    <div id="digital-clock">
                        <div class="clock-segment"><span id="clock-hours">00</span></div><div id="main-colon" class="clock-separator">:</div><div class="clock-segment"><span id="clock-minutes">00</span></div>
                        <div class="clock-seconds">
                            <div class="clock-separator">:</div><div class="clock-segment"><span id="clock-seconds">00</span></div>
                        </div>
                    </div>
                </div>
                <div id="date-weather-group" class="flex-grow-item">
                    <div id="date-container" class="date-container"><p id="gregorian-date-p"></p><p id="lunar-date-p"></p><p id="lunar-event"></p></div>
                    <div id="weather-container" class="weather-container">
                        <span id="weather-location"></span><span id="weather-icon"></span><span id="weather-temp"></span><span id="weather-desc">Đang tải thời tiết...</span>
                    </div>
                </div>
                <div id="calendar-wrapper" class="flex-grow-item">
                     <div id="calendar-container">
                        <div id="calendar-header"><div class="calendar-nav" id="prev-btn">&lt;</div><div id="calendar-title"></div><div class="calendar-nav" id="next-btn">&gt;</div></div>
                        <div id="calendar-grid"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="qr-column">
            <div class="qr-wrapper" id="qr-wrapper-desktop">
                <img class="qr-code-image" id="qr-code-image-desktop" src="" alt="Mã QR">
                <div class="shop-info">
                    <p class="shop-name" id="shop-name-desktop"></p>
                    <p class="shop-address" id="shop-address-desktop"></p>
                </div>
            </div>
        </div>

        <div id="clock-only-date-container">
            <p id="gregorian-date-overlay"></p>
            <p id="lunar-date-overlay" style="color: #f39c12;"></p>
        </div>
    </div>
    
    <div id="settings-container">
        <button id="settings-toggle" aria-label="Mở hoặc đóng bảng cài đặt"><span>&#9776;</span></button>
        <div id="settings-panel">
            <button class="settings-btn" id="clock-only-toggle">Chế độ Đồng hồ</button>
            <button class="settings-btn sub-option" id="clock-only-gregorian-toggle">Hiện Dương lịch</button>
            <button class="settings-btn sub-option" id="clock-only-lunar-toggle">Hiện Âm lịch</button>
            <hr style="border-color: #444; margin: 10px 0;">
            <button class="settings-btn" id="fullscreen-toggle">Toàn màn hình</button><hr style="border-color: #444; margin: 10px 0;">
            <button class="settings-btn" id="online-photos-toggle">Dùng ảnh online</button>
            <button class="settings-btn" id="slideshow-toggle">Ẩn các khối</button>
            <button class="settings-btn" id="shop-toggle-btn">Ẩn Shop</button>
            <button class="settings-btn" id="qr-toggle-btn">Ẩn Mã QR</button>
            <button class="settings-btn" id="seconds-toggle">Hiện giây</button>
            <button class="settings-btn" id="date-toggle">Ẩn Ngày tháng</button>
            <button class="settings-btn" id="calendar-toggle">Ẩn Lịch</button>
            <button class="settings-btn" id="weather-toggle">Ẩn Thời tiết</button><hr style="border-color: #444; margin: 10px 0;">
            <button class="settings-btn" id="refresh-photos-btn">Ảnh mới ngay</button>
            <button class="settings-btn" id="photo-guide-btn">HD: Cập nhật ảnh</button>
            <button class="settings-btn" id="always-on-guide-btn">HD: Giữ màn hình bật</button><hr style="border-color: #444; margin: 10px 0;">
            <button class="settings-btn" id="reset-settings-btn">Đặt lại Cài đặt</button>
        </div>
    </div>
    
    <div id="guide-dialog" class="dialog-overlay">
        <div class="dialog-box">
            <h3 id="guide-title"></h3>
            <div id="guide-content"></div>
        </div>
    </div>
    
    <script>
    var LUNAR_INFO=[0x04bd8,0x04ae0,0x0a570,0x054d5,0x0d260,0x0d950,0x16554,0x056a0,0x09ad0,0x055d2,0x04ae0,0x0a5b6,0x0a4d0,0x0d250,0x1d255,0x0b540,0x0d6a0,0x0ada2,0x095b0,0x14977,0x04970,0x0a4b0,0x0b4b5,0x06a50,0x06d40,0x1ab54,0x02b60,0x09570,0x052f2,0x04970,0x06566,0xd4a0,0x0ea50,0x06e95,0x05ad0,0x02b60,0x186e3,0x092e0,0x1c8d7,0x0c950,0x0d4a0,0x1d8a6,0x0b550,0x056a0,0x1a5b4,0x025d0,0x092d0,0x0d2b2,0x0a950,0x0b557,0x06ca0,0x0b550,0x15355,0x04da0,0x0a5d0,0x14573,0x052d0,0x0a9a8,0x0e950,0x06aa0,0x0aea6,0x0ab50,0x04b60,0x0aae4,0x0a570,0x05260,0x0f263,0x0d950,0x05b57,0x056a0,0x096d0,0x04dd5,0x04ad0,0x0a4d0,0x0d4d4,0x0d250,0x0d558,0x0b540,0x0b5a0,0x195a6,0x095b0,0x049b0,0x0a974,0x0a4b0,0x0b27a,0x06a50,0x06d40,0x0af46,0x0ab60,0x09570,0x04970,0x04970,0x064b0,0x074a3,0x0ea50,0x06b58,0x055c0,0x0ab60,0x096d5,0x092e0,0x0c960,0x0d954,0xd4a0,0x0da50,0x07552,0x056a0,0x0abb7,0x025d0,0x092d0,0x0cab5,0x0a950,0x0b4a0,0x0baa4,0x0ad50,0x055d9,0x04ba0,0x0a5b0,0x15176,0x052b0,0x0a930,0x07954,0x06aa0,0x0ad50,0x05b52,0x04b60,0x0a6e6,0x0a4e0,0x0d260,0xea65,0x0d530,0x05aa0,0x076a3,0x096d0,0x04bd7,0x04ad0,0x0a4d0,0x1d0b6,0x0d250,0x0d520,0x0dd45,0x0b5a0,0x056d0,0x055b2,0x049b0,0x0a577,0x0a4b0,0x0aa50,0x1b255,0x06d20,0x0ada0];
    var CAN_STR=["Canh","Tân","Nhâm","Quý","Giáp","Ất","Bính","Đinh","Mậu","Kỷ"]; var CHI_STR=["Thân","Dậu","Tuất","Hợi","Tý","Sửu","Dần","Mão","Thìn","Tỵ","Ngọ","Mùi"];
    function getLunarMonthDays(y,m){return(LUNAR_INFO[y-1900]&(0x10000>>m))?30:29} function getLeapMonth(y){return LUNAR_INFO[y-1900]&0xf}
    function getLunarYearDays(y){var i,sum=384;for(i=0x8000;i>0x8;i>>=1)sum+=LUNAR_INFO[y-1900]&i?1:0;return sum+getLunarMonthDays(y,getLeapMonth(y))}
    function solarToLunar(dd,mm,yy){var date=new Date(yy,mm-1,dd);var offset=Math.floor((date.getTime()-new Date(1900,0,31).getTime())/864e5);var day=offset;var lunarYear,lunarMonth,lunarDay,isLeap;var i,temp=0;for(i=1900;i<2101&&day>0;i++){temp=getLunarYearDays(i);day-=temp}if(day<0){day+=temp;i--}lunarYear=i;var leap=getLeapMonth(lunarYear);isLeap=false;for(i=1;i<13&&day>0;i++){if(leap>0&&i==leap+1&&!isLeap){--i;isLeap=true;temp=getLunarMonthDays(lunarYear,0)}else{temp=getLunarMonthDays(lunarYear,i)}if(isLeap&&i==leap+1)isLeap=false;day-=temp}if(day==0&&leap>0&&i==leap+1){if(isLeap){isLeap=false}else{isLeap=true;--i}}if(day<0){day+=temp;--i}lunarMonth=i;lunarDay=day+1;return{day:lunarDay,lunarMonth:lunarMonth,lunarYear:lunarYear,monthName:"tháng "+lunarMonth+(isLeap?" nhuận":""),yearName:"năm "+CAN_STR[(lunarYear-4)%10]+" "+CHI_STR[(lunarYear-4)%12],dayCanChi:CAN_STR[(offset+4)%10]+" "+CHI_STR[(offset+0)%12]}}
    
    document.addEventListener("DOMContentLoaded", function() {
        var REMOTE_IMAGE_MANIFEST_URL = 'https://gist.githubusercontent.com/anlvdt/66f712365351cc8cfc2ad27718b2c9d7/raw/c2cdaa42b282b28e8024417771f314e421b074a7/slideshow_images.json';
        var REMOTE_CONFIG_URL = 'https://gist.githubusercontent.com/anlvdt/5ba20e2a08249bcac84aca7f2c371f0b/raw/7470ffdaf1a0dc18306599033555bf029073858e/config.json';

        var els = { container: document.getElementById('main-container'), infoColumn: document.getElementById('info-column'), clock: document.getElementById('digital-clock'), mainColon: document.getElementById('main-colon'), dateWeatherGroup: document.getElementById('date-weather-group'), calendarWrapper: document.getElementById('calendar-wrapper'), weatherLocation: document.getElementById('weather-location'), weatherIcon: document.getElementById('weather-icon'), weatherTemp: document.getElementById('weather-temp'), weatherDesc: document.getElementById('weather-desc'), prevBtn: document.getElementById('prev-btn'), nextBtn: document.getElementById('next-btn'), backgroundImage: document.getElementById('background-image'), settingsToggle: document.getElementById('settings-toggle'), settingsPanel: document.getElementById('settings-panel'), slideshowToggleBtn: document.getElementById('slideshow-toggle'), shopToggleBtn: document.getElementById('shop-toggle-btn'), qrToggleBtn: document.getElementById('qr-toggle-btn'), secondsBtn: document.getElementById('seconds-toggle'), dateToggleBtn: document.getElementById('date-toggle'), calendarToggleBtn: document.getElementById('calendar-toggle'), weatherToggleBtn: document.getElementById('weather-toggle'), fullscreenBtn: document.getElementById('fullscreen-toggle'), resetSettingsBtn: document.getElementById('reset-settings-btn'), refreshPhotosBtn: document.getElementById('refresh-photos-btn'), photoGuideBtn: document.getElementById('photo-guide-btn'), alwaysOnGuideBtn: document.getElementById('always-on-guide-btn'), guideDialog: document.getElementById('guide-dialog'), guideTitle: document.getElementById('guide-title'), guideContent: document.getElementById('guide-content'), clockOnlyToggleBtn: document.getElementById('clock-only-toggle'), clockOnlyGregorianBtn: document.getElementById('clock-only-gregorian-toggle'), clockOnlyLunarBtn: document.getElementById('clock-only-lunar-toggle'), gregorianDateOverlay: document.getElementById('gregorian-date-overlay'), lunarDateOverlay: document.getElementById('lunar-date-overlay'), onlinePhotosBtn: document.getElementById('online-photos-toggle') };
        var images = [], currentImageIndex = 0, slideshowInterval = null, currentDateForCalendar = new Date(), lastTime = {};
        var settings = { slideshowHidden: false, shopHidden: false, qrHidden: false, secondsVisible: false, dateHidden: false, calendarHidden: false, weatherHidden: false, clockOnlyMode: false, clockOnlyShowGregorian: false, clockOnlyShowLunar: false, useOnlinePhotos: false };
        
        function updateClock() { var now = new Date(); var h = ('0' + now.getHours()).slice(-2); var m = ('0' + now.getMinutes()).slice(-2); var s = ('0' + now.getSeconds()).slice(-2); if (lastTime.h !== h) { document.getElementById('clock-hours').textContent = h; lastTime.h = h; } if (lastTime.m !== m) { document.getElementById('clock-minutes').textContent = m; lastTime.m = m; } if (settings.secondsVisible) { document.getElementById('clock-seconds').textContent = s; } }
        function updateMainDate() { var now = new Date(); var dayOfWeek = ["Chủ Nhật", "Thứ Hai", "Thứ Ba", "Thứ Tư", "Thứ Năm", "Thứ Sáu", "Thứ Bảy"]; var gregorianText = dayOfWeek[now.getDay()] + ', ngày ' + now.getDate() + ' tháng ' + (now.getMonth() + 1) + ' năm ' + now.getFullYear(); var lunar = solarToLunar(now.getDate(), now.getMonth() + 1, now.getFullYear()); var lunarText = 'Âm lịch: ' + lunar.dayCanChi + ', ngày ' + lunar.day + ' ' + lunar.monthName; document.getElementById('gregorian-date-p').innerText = gregorianText; document.getElementById('lunar-date-p').innerText = lunarText; els.gregorianDateOverlay.innerText = gregorianText; els.lunarDateOverlay.innerText = lunarText; var eventText = ""; var daysInMonth = getLunarMonthDays(lunar.lunarYear, lunar.lunarMonth); if (lunar.day === 1) eventText = "Mồng 1"; else if (lunar.day === 15) eventText = "Ngày Rằm"; else if (lunar.day === 16) eventText = "Ngày 16"; else if (lunar.day === daysInMonth) eventText = "Ngày cuối tháng"; document.getElementById('lunar-event').innerText = eventText; }
        function makeRequest(url, callback) { var xhr = new XMLHttpRequest(); xhr.onreadystatechange = function() { if (xhr.readyState === 4) { if (xhr.status >= 200 && xhr.status < 300) { try { callback(null, JSON.parse(xhr.responseText)); } catch(e) { callback(e, null); } } else { callback(new Error('Yêu cầu mạng thất bại: ' + xhr.status), null); } } }; xhr.open('GET', url, true); xhr.send(); }
        
        function getWeatherInfoFromWttr(code) { var map = { "395":{d:"Tuyết và dông",i:"🌨️"},"392":{d:"Tuyết nhẹ và dông",i:"🌨️"},"389":{d:"Mưa và dông",i:"⛈️"},"386":{d:"Mưa nhẹ và dông",i:"⛈️"},"377":{d:"Mưa đá",i:"🌨️"},"374":{d:"Mưa đá nhỏ",i:"🌨️"},"368":{d:"Mưa tuyết nhẹ",i:"🌨️"},"359":{d:"Mưa lớn",i:"🌧️"},"356":{d:"Mưa rào lớn",i:"🌧️"},"353":{d:"Mưa rào nhẹ",i:"🌦️"},"350":{d:"Mưa đá",i:"🌨️"},"338":{d:"Tuyết dày",i:"🌨️"},"335":{d:"Tuyết rơi dày",i:"🌨️"},"332":{d:"Tuyết",i:"❄️"},"329":{d:"Tuyết vừa",i:"❄️"},"326":{d:"Tuyết nhẹ",i:"❄️"},"323":{d:"Tuyết nhẹ",i:"❄️"},"320":{d:"Mưa tuyết",i:"🌨️"},"317":{d:"Mưa tuyết nhẹ",i:"🌨️"},"314":{d:"Mưa phùn lạnh",i:"🌨️"},"311":{d:"Mưa phùn lạnh",i:"🌨️"},"308":{d:"Mưa lớn",i:"🌧️"},"305":{d:"Mưa lớn",i:"🌧️"},"302":{d:"Mưa vừa",i:"🌧️"},"299":{d:"Mưa vừa",i:"🌧️"},"296":{d:"Mưa nhẹ",i:"🌦️"},"293":{d:"Mưa nhẹ",i:"🌦️"},"284":{d:"Mưa phùn lạnh",i:"🌨️"},"281":{d:"Mưa phùn lạnh",i:"🌨️"},"266":{d:"Mưa phùn nhẹ",i:"🌦️"},"263":{d:"Mưa phùn nhẹ",i:"🌦️"},"260":{d:"Sương mù",i:"🌫️"},"248":{d:"Sương mù",i:"🌫️"},"230":{d:"Bão tuyết",i:"🌨️"},"227":{d:"Tuyết bay",i:"🌨️"},"200":{d:"Dông",i:"⚡"},"185":{d:"Mưa phùn lạnh",i:"🌨️"},"182":{d:"Mưa tuyết nhẹ",i:"🌨️"},"179":{d:"Tuyết nhẹ",i:"❄️"},"176":{d:"Mưa rào",i:"🌦️"},"143":{d:"Sương mù",i:"🌫️"},"122":{d:"Nhiều mây",i:"☁️"},"119":{d:"Nhiều mây",i:"☁️"},"116":{d:"Mây rải rác",i:"🌥️"},"113":{d:"Trời quang",i:"☀️"}}; return map[code] || {d:"Không xác định", i:"🤷"}; }
        function loadAutomaticWeather() {
            makeRequest('https://ip-api.com/json/', function(err, data) {
                if (err || !data || data.status !== 'success') {
                    console.error("Lỗi xác định vị trí:", err);
                    els.weatherDesc.textContent = "Lỗi vị trí";
                    return;
                }
                var city = data.city;
                var weatherUrl = 'https://wttr.in/' + encodeURIComponent(city) + '?format=j1';
                makeRequest(weatherUrl, function(err, weatherData){
                    if(err || !weatherData){
                        console.error("Lỗi tải thời tiết từ wttr.in:", err);
                        els.weatherDesc.textContent = "Lỗi thời tiết";
                        return;
                    }
                    var current = weatherData.current_condition[0];
                    var info = getWeatherInfoFromWttr(current.weatherCode);
                    els.weatherLocation.textContent = city;
                    els.weatherIcon.textContent = info.i;
                    els.weatherTemp.textContent = current.temp_C + "°C";
                    els.weatherDesc.textContent = info.d;
                });
            });
        }

        function fetchOnlinePhoto() {
            var keywords = 'nature,landscape,water,sky,travel'; 
            var apiUrl = 'https://source.unsplash.com/random/1920x1080?' + keywords;
            var uniqueUrl = apiUrl + '&t=' + new Date().getTime();
            
            var tempImg = new Image();
            tempImg.onload = function() {
                els.backgroundImage.src = tempImg.src;
                els.backgroundImage.classList.add('loaded');
            };
            tempImg.onerror = function() { console.error("Lỗi tải ảnh từ Unsplash Source."); };
            tempImg.src = uniqueUrl;
        }

        function fetchAndUpdateRemoteImages() { 
            if (settings.useOnlinePhotos) {
                fetchOnlinePhoto();
            } else {
                makeRequest(REMOTE_IMAGE_MANIFEST_URL + '?t=' + new Date().getTime(), function(err, data) { 
                    if (err || !Array.isArray(data) || data.length === 0) { 
                        console.error("Lỗi tải hoặc danh sách ảnh trống.");
                        images = []; startSlideshow();
                        return; 
                    }
                    images = data;
                    currentImageIndex = 0;
                    startSlideshow();
                }); 
            }
        }
        function fetchRemoteConfig() { makeRequest(REMOTE_CONFIG_URL + '?t=' + new Date().getTime(), function(err, data) { if (err || !data) { console.error("Lỗi tải cấu hình QR.", err); data = {}; } var qrUrl = data.qrImageUrl || ""; var shopName = data.shopName || "Tên Cửa Hàng"; var shopAddress = data.shopAddress || "Địa chỉ cửa hàng"; document.getElementById('qr-code-image-desktop').src = qrUrl; document.getElementById('shop-name-desktop').textContent = shopName; document.getElementById('shop-address-desktop').textContent = shopAddress; }); }
        
        function changeImage() {
            els.backgroundImage.classList.remove('loaded');
            
            setTimeout(function() {
                if (settings.useOnlinePhotos) {
                    fetchOnlinePhoto();
                } else {
                    if (images.length === 0) return;
                    if (images.length <= 1) {
                        els.backgroundImage.classList.add('loaded');
                        return; 
                    }
                    currentImageIndex = (currentImageIndex + 1) % images.length; 
                    els.backgroundImage.src = images[currentImageIndex];
                }
            }, 1000);
        }

        function startSlideshow() { 
            if(slideshowInterval) clearInterval(slideshowInterval); 
            
            if (!settings.useOnlinePhotos) {
                 if (images.length > 0) {
                    els.backgroundImage.src = images[currentImageIndex];
                    els.backgroundImage.classList.add('loaded');
                }
            }
            slideshowInterval = setInterval(changeImage, 8000);
        }
        
        function saveSettings() { try { localStorage.setItem('dashboardSettings', JSON.stringify(settings)); } catch (e) { console.error("Không thể lưu cài đặt:", e); } }
        
        function applySettings() {
            els.container.className = "container"; 
            if (settings.slideshowHidden) els.container.classList.add('slideshow-hidden');
            if (settings.shopHidden) els.container.classList.add('shop-hidden');
            if (settings.qrHidden) els.container.classList.add('qr-hidden');
            if (settings.clockOnlyMode) els.container.classList.add('clock-only-mode');

            if (settings.clockOnlyMode && (settings.clockOnlyShowGregorian || settings.clockOnlyShowLunar)) {
                els.container.classList.add('show-dates');
            }
            
            els.gregorianDateOverlay.style.display = settings.clockOnlyShowGregorian ? 'block' : 'none';
            els.lunarDateOverlay.style.display = settings.clockOnlyShowLunar ? 'block' : 'none';
            
            els.clock.classList[settings.secondsVisible ? 'add' : 'remove']('seconds-visible');
            if (settings.secondsVisible) { els.mainColon.classList.remove('colon-blinking'); } 
            else { els.mainColon.classList.add('colon-blinking'); }

            els.slideshowToggleBtn.textContent = settings.slideshowHidden ? 'Hiện các khối' : 'Ẩn các khối';
            els.onlinePhotosBtn.textContent = settings.useOnlinePhotos ? 'Dùng ảnh cá nhân' : 'Dùng ảnh online';
            els.shopToggleBtn.textContent = settings.shopHidden ? 'Hiện Shop' : 'Ẩn Shop';
            els.qrToggleBtn.textContent = settings.qrHidden ? 'Hiện Mã QR' : 'Ẩn Mã QR';
            els.secondsBtn.textContent = settings.secondsVisible ? 'Ẩn giây' : 'Hiện giây';
            els.calendarWrapper.classList[settings.calendarHidden ? 'add' : 'remove']('hidden-force'); els.calendarToggleBtn.textContent = settings.calendarHidden ? 'Hiện Lịch' : 'Ẩn Lịch';
            
            document.getElementById('date-container').classList[settings.dateHidden ? 'add' : 'remove']('hidden-force');
            document.getElementById('weather-container').classList[settings.weatherHidden ? 'add' : 'remove']('hidden-force');
            els.dateWeatherGroup.classList[settings.dateHidden && settings.weatherHidden ? 'add' : 'remove']('hidden-force');
            
            els.dateToggleBtn.textContent = settings.dateHidden ? 'Hiện Ngày tháng' : 'Ẩn Ngày tháng';
            els.weatherToggleBtn.textContent = settings.weatherHidden ? 'Hiện Thời tiết' : 'Ẩn Thời tiết';
            els.clockOnlyToggleBtn.textContent = settings.clockOnlyMode ? 'Thoát CĐ Đồng hồ' : 'Chế độ Đồng hồ';
            els.clockOnlyGregorianBtn.textContent = settings.clockOnlyShowGregorian ? 'Tắt Dương lịch' : 'Bật Dương lịch';
            els.clockOnlyLunarBtn.textContent = settings.clockOnlyShowLunar ? 'Tắt Âm lịch' : 'Bật Âm lịch';
        }
        
        function loadSettings() { try { var savedSettings = localStorage.getItem('dashboardSettings'); if (savedSettings) { settings = Object.assign(settings, JSON.parse(savedSettings)); } } catch (e) { console.error("Không thể tải cài đặt:", e); } applySettings(); }
        function updateLayout() { renderCalendar(); }
        function renderCalendar() { var isVertical = window.innerWidth <= 800; var calendarFn = isVertical ? generateMonthlyCalendar : generateWeeklyCalendar; calendarFn(currentDateForCalendar); }
        function generateWeeklyCalendar(baseDate) { var grid=document.getElementById('calendar-grid');grid.innerHTML='';var today=new Date();var dayNames=['CN','T2','T3','T4','T5','T6','T7'];var weekStart=new Date(baseDate);weekStart.setDate(baseDate.getDate()-baseDate.getDay());var weekEnd=new Date(weekStart);weekEnd.setDate(weekStart.getDate()+6);document.getElementById('calendar-title').textContent='Tuần: '+weekStart.getDate()+'/'+(weekStart.getMonth()+1)+' - '+weekEnd.getDate()+'/'+(weekEnd.getMonth()+1);dayNames.forEach(function(name){var dayEl=document.createElement('div');dayEl.className='calendar-cell day-name';dayEl.innerHTML='<div class="cell-content">'+name+'</div>';grid.appendChild(dayEl);});for(var i=0;i<7;i++){var currentDay=new Date(weekStart);currentDay.setDate(weekStart.getDate()+i);var solarDay=currentDay.getDate();var lunar=solarToLunar(solarDay,currentDay.getMonth()+1,currentDay.getFullYear());var lunarDisplay=lunar.day===1?lunar.day+'/'+lunar.lunarMonth:lunar.day;var dayEl=document.createElement('div');dayEl.className='calendar-cell';if(currentDay.getDate()===today.getDate()&&currentDay.getMonth()===today.getMonth()&&currentDay.getFullYear()===today.getFullYear()){dayEl.classList.add('today');}dayEl.innerHTML='<div class="calendar-cell-inner"><div class="cell-content"><span class="solar-day">'+solarDay+'</span><span class="lunar-day">'+lunarDisplay+'</span></div></div>';grid.appendChild(dayEl);} }
        function generateMonthlyCalendar(baseDate) { var grid=document.getElementById('calendar-grid');grid.innerHTML='';var today=new Date();var year=baseDate.getFullYear();var month=baseDate.getMonth();document.getElementById('calendar-title').textContent='Tháng '+(month+1)+' '+year;var firstDayOfMonth=new Date(year,month,1).getDay();var daysInMonth=new Date(year,month+1,0).getDate();var dayNames=['CN','T2','T3','T4','T5','T6','T7'];dayNames.forEach(function(name){var dayEl=document.createElement('div');dayEl.className='calendar-cell day-name';dayEl.innerHTML='<div class="cell-content">'+name+'</div>';grid.appendChild(dayEl);});for(var i=0;i<firstDayOfMonth;i++){var dayEl=document.createElement('div');dayEl.className='calendar-cell other-month';grid.appendChild(dayEl);}for(var i=1;i<=daysInMonth;i++){var solarDay=i;var lunar=solarToLunar(solarDay,month+1,year);var lunarDisplay=lunar.day===1?lunar.day+'/'+lunar.lunarMonth:lunar.day;var dayEl=document.createElement('div');dayEl.className='calendar-cell';if(solarDay===today.getDate()&&month===today.getMonth()&&year===today.getFullYear()){dayEl.classList.add('today');}dayEl.innerHTML='<div class="calendar-cell-inner"><div class="cell-content"><span class="solar-day">'+solarDay+'</span><span class="lunar-day">'+lunarDisplay+'</span></div></div>';grid.appendChild(dayEl);} }
        function showGuide(type) { var guides = { photo: { title: 'Hướng dẫn Cập nhật Ảnh', content: '<ul><li>Bạn có thể dùng danh sách ảnh cá nhân (cấu hình trong file Gist) hoặc dùng ảnh online từ Unsplash.</li><li>Để dùng ảnh online, bạn không cần API Key, chỉ cần bật tùy chọn trong menu. Bạn có thể tùy chỉnh chủ đề ảnh bằng cách sửa các từ khóa trong mã nguồn.</li><li>Sử dụng nút "Dùng ảnh online" trong menu cài đặt để chuyển đổi giữa hai chế độ.</li></ul>' }, alwaysOn: { title: 'Hướng dẫn Giữ Màn hình Bật', content: '<ul><li><b>iPad/iPhone:</b> Vào Cài đặt > Màn hình & Độ sáng > Tự động khoá > chọn "Không".</li><li><b>Android:</b> Vào Cài đặt > Màn hình > Thời gian sáng màn hình > chọn thời gian dài nhất hoặc "Không bao giờ". Một số máy cần bật "Tuỳ chọn nhà phát triển" để có tuỳ chọn "Luôn bật khi sạc".</li><li><b>Windows/macOS:</b> Vào phần cài đặt Năng lượng (Power/Energy Saver) và đặt thời gian tắt màn hình thành "Không bao giờ" (Never).</li></ul>' } }; var guide = guides[type]; els.guideTitle.innerHTML = guide.title; els.guideContent.innerHTML = guide.content; els.guideDialog.classList.add('show'); }
        
        els.prevBtn.addEventListener('click', function() { currentDateForCalendar.setMonth(currentDateForCalendar.getMonth() - 1); renderCalendar(); });
        els.nextBtn.addEventListener('click', function() { currentDateForCalendar.setMonth(currentDateForCalendar.getMonth() + 1); renderCalendar(); });
        window.addEventListener('resize', function() { setTimeout(updateLayout, 200); });
        els.settingsToggle.addEventListener('click', function() { els.settingsPanel.classList.toggle('show'); });
        els.resetSettingsBtn.addEventListener('click', function() { if (confirm('Bạn có chắc muốn đặt lại tất cả cài đặt?')) { localStorage.removeItem('dashboardSettings'); window.location.reload(); } });
        els.fullscreenBtn.addEventListener('click', function() { var docElm = document.documentElement; if (docElm.requestFullscreen) { if (!document.fullscreenElement) { docElm.requestFullscreen(); } else { document.exitFullscreen(); } } else if (docElm.webkitRequestFullscreen) { if (!document.webkitFullscreenElement) { docElm.webkitRequestFullscreen(); } else { document.webkitExitFullscreen(); } } });
        
        var toggleButtons = { slideshowToggleBtn: 'slideshowHidden', shopToggleBtn: 'shopHidden', qrToggleBtn: 'qrHidden', dateToggleBtn: 'dateHidden', calendarToggleBtn: 'calendarHidden', weatherToggleBtn: 'weatherHidden', secondsBtn: 'secondsVisible', clockOnlyToggleBtn: 'clockOnlyMode', clockOnlyGregorianBtn: 'clockOnlyShowGregorian', clockOnlyLunarBtn: 'clockOnlyShowLunar', onlinePhotosBtn: 'useOnlinePhotos' };
        for (var btnId in toggleButtons) { (function(id, settingKey) { if(els[id]) { els[id].addEventListener('click', function() { settings[settingKey] = !settings[settingKey]; saveSettings(); applySettings(); if(settingKey === 'useOnlinePhotos'){ fetchAndUpdateRemoteImages(); } }); } })(btnId, toggleButtons[btnId]); }

        els.refreshPhotosBtn.addEventListener('click', function() {
            if(slideshowInterval) clearInterval(slideshowInterval);
            fetchAndUpdateRemoteImages();
            els.settingsPanel.classList.remove('show');
        });
        els.photoGuideBtn.addEventListener('click', function() { showGuide('photo'); });
        els.alwaysOnGuideBtn.addEventListener('click', function() { showGuide('alwaysOn'); });
        els.guideDialog.addEventListener('click', function(e) { if(e.target === els.guideDialog) { els.guideDialog.classList.remove('show'); } });
        els.backgroundImage.addEventListener('load', function() { this.classList.add('loaded'); });
        els.backgroundImage.onerror = function() { console.warn("Lỗi tải ảnh. Đang thử tải ảnh mới..."); setTimeout(changeImage, 1000); };
        
        loadSettings(); updateClock(); updateMainDate(); updateLayout(); loadAutomaticWeather(); fetchAndUpdateRemoteImages(); fetchRemoteConfig();
        setInterval(updateClock, 1000); 
        setInterval(loadAutomaticWeather, 1800000); 
        setInterval(function() { if (!settings.useOnlinePhotos) fetchAndUpdateRemoteImages(); }, 3600000); 
        setInterval(function() { var now = new Date(); if (now.getMinutes() === 0 && now.getSeconds() < 2) { updateMainDate(); currentDateForCalendar = new Date(); renderCalendar(); } }, 1000);
    });
    </script>
</body>
</html>
